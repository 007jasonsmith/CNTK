WorkDir=.
ModelDir=$WorkDir$/_out/$ConfigName$
stderr=$WorkDir$/_out/$ConfigName$

ndlMacros=$WorkDir$/Macros.ndl

precision=float
deviceId=Auto

command=Train:AddTop5Eval:Test

Train=[
    action=train
    modelPath=$ModelDir$/AlexNet
    traceLevel=1

    NDLNetworkBuilder=[
        networkDescription=$WorkDir$/AlexNet.ndl
    ]
    
    SGD=[
        epochSize=0
        minibatchSize=128
        learningRatesPerMB=0.01*20:0.003*12:0.001*28:0.0003
        momentumPerMB=0.9
        maxEpochs=90
        gradUpdateType=None
        L2RegWeight=0.0005
        dropoutRate=0*5:0.5
        
        numMBsToShowResult=10
    ]
    
    reader=[
        readerType=ImageReader
        file=$WorkDir$/train_map.txt
        randomize=None
        features=[
            width=224
            height=224
            channels=3
            cropType=Random
            #hflip=0
            cropRatio=0.9
            meanFile=$WorkDir$/ImageNet1K_mean.xml
        ]
        labels=[
            labelDim=1000
        ]
    ]    
]

AddTop5Eval=[    
    action=edit
    CurModel=$ModelDir$/AlexNet
    NewModel=$ModelDir$/AlexNet.Top5
    editPath=$WorkDir$/add_top5_layer.mel
]

Test=[
    action=test
    modelPath=$ModelDir$/AlexNet.Top5
    # Set minibatch size for testing.
    minibatchSize=128

     NDLNetworkBuilder=[
        networkDescription=$WorkDir$/AlexNet.ndl
    ]
    
    reader=[
        readerType=ImageReader
        file=$WorkDir$/val_map.txt
        randomize=None
        features=[
            width=224
            height=224
            channels=3
            cropType=Center
            meanFile=$WorkDir$/ImageNet1K_mean.xml
        ]
        labels=[
            labelDim=1000
        ]
    ]    
]
